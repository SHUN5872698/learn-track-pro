# これまでの議論の要点まとめ（最新版：2026年2月11日更新）

## 背景・経緯

### プロジェクトの概要

- **プロジェクト名**: LearnTrack Pro - プログラミング学習管理プラットフォーム
- **技術スタック**: Laravel 12 / Vue 3 (Composition API) / Pinia / MySQL 8.0
- **構成**: モノリシックSPA
- **現在の状態**: プロフィール画像アップロード機能完了・本番デプロイ済み、CI/CD段階的導入中

### 目的・目標

- 転職活動用ポートフォリオとして公開
- プロフィール画像アップロード機能を題材にCI/CDを段階的導入
- 「テスト→CI→デプロイ自動化」の順で実装

### 主要な制約

- TypeScript不使用、Bootstrap/jQuery/Options API禁止
- 個人開発のため実装工数を最小限に
- デプロイ優先、完璧主義を避ける
- **予算制約**: 月1,000-3,000円（転職活動期間3-6ヶ月）
- **Git管理対象**: `laravel-docker/src/`のみ（インフラ設定は対象外）
- **転職活動タイムライン**: 2026年1月〜3月が書類選考・面接期間

---

## 完了・確定事項

### プロジェクトの現在地

- ✅ Phase 0-3: アプリケーション開発・VPS環境構築・SSL化完了
- ✅ プロフィール画像アップロード機能: 全Phase完了（Phase 1-5）、本番デプロイ済み
- ✅ ドキュメント更新: 全対象ドキュメント更新完了
- ✅ 用語統一: 「アバター」→「プロフィール画像」
- ✅ CI基盤: PR単位のPHPUnit自動実行（1機能）を導入・検証完了
- ✅ PR運用ルール策定: テンプレート・ラベル・レビュー観点・Draft運用を確定
- ✅ 初回リリースフロー完走: Draft PR検証→feature→develop→main→本番デプロイ
- 🔄 CI/CD拡張: 全テスト対象への拡張・CD（自動デプロイ）は未着手

### 直近完了した実装（2/10）

1. ✅ CI検証→PR #16マージ→develop→main→本番デプロイの一連のフローを完走
2. ✅ PRワークフロー（GEMINI.md定義・プロンプト・テンプレート）の実装・検証
3. ✅ 手動デプロイ手順の効率化（Makeコマンド活用、コンテナ出入り削減）
4. ✅ PR運用ルールドキュメント作成
5. ✅ README更新（プロフィール画像機能・今後の展望の進捗反映）

### 作成済みドキュメント

- 環境構築メモ①〜⑧、本番環境構築手順書
- API設計（包括的ドキュメント）、各API仕様書
- プロフィール画像アップロードユニットテスト仕様書
- 開発フロー改善仕様（AIエディタ + CI/CD統合）
- TasksDB vs 開発ドキュメント管理DB：使い分けガイド
- PR運用ルール（テンプレート運用・ラベル・レビュー観点・Draft PR）
- 手動デプロイフロー（パターン1〜3、チェックリスト、Makeコマンド）

---

## これまでの議論で確定した方針

### 1. Service層の導入方針

**要点**: 機能単位（`User/AvatarService`）でService層を導入。Repository層は不要。

**判断基準**: 個人開発の規模ではRepository層はオーバースペック

### 2. バリデーション構成

**要点**: Laravelの`mimes`ルールのみ使用、マジックバイト検証はServiceで実施

**判断基準**: `mimes`は内部でMIMEタイプを検証するため`mimetypes`との併用は不要

### 3. テスト方針（画像テスト）

**要点**: 実画像フィクスチャを使用。`UploadedFile::fake()->create()`はマジックバイト検証で失敗する。

**判断基準**: Laravelの`fake()->image()`はWebP非対応、`fake()->create()`は正しいマジックバイトを持たない

### 4. ユニットテストと統合テストの分離

**要点**: PHPUnit（バックエンド）とApidog・手動（統合）を分けて実施

**判断基準**: バックエンド/フロントエンドで区切る方が進捗管理しやすい

### 5. ドキュメント運用ルール

**要点**: テスト種別ごとに専用ドキュメントを作成、タスクページには参照リンクのみ

**判断基準**: 完了した作業の詳細をタスクページに書くと更新が雑になる

### 6. 汎用コンポーネントの拡張方針（icon-dark）

**要点**: BaseButtonに暗い背景用variant（icon-dark）を追加。フォーカスリング無効化。

**判断基準**: 既存variantに影響を与えず、新variantで対応

### 7. ディレクトリ命名規則

**要点**: 全て複数形に統一（`tests/units/`, `tests/manuals/`）

**判断基準**: チーム開発を前提としたシンプルなルール

### 8. 開発フロー（AIエディタ + CI/CD統合）

**要点**: Notion（仕様確認・ドキュメント管理）→ Antigravity（メイン実装）→ GeminiCLI（小タスク）→ GitHub Actions（CI/CD）

**判断基準**: 各ツールの強みを活かした役割分担

詳細: 開発フロー改善仕様参照

### 9. PR運用ルール

**要点**: PR本文は「レビューしてほしいこと（変更箇所ベース）」を核にテンプレート（feature.md）で標準化。ラベルはConventional Commitsのタイプ体系と整合。

**判断基準**: チーム開発を前提とした運用の型を個人開発段階から定着させる

### 10. Issue-PR紐づけルール

**要点**: 原則`Refs #<issue>`を使い、`Fixes`はmainへの本番反映PRに限定する。

**判断基準**: 検証用PRやDraft PRでIssueが意図せずクローズされる事故を防ぐ

### 11. CIワークフロー検証方針

**要点**: 検証用ブランチからDraft PRを作成してCI起動を確認し、マージせずCloseする。成功コミットはローカルマージで実装ブランチに取り込む。

**判断基準**: main/developの履歴を汚さず、試行錯誤のノイズコミットを隔離する

### 12. workflow_dispatchの前提条件

**要点**: `workflow_dispatch`（手動実行）はデフォルトブランチにワークフローが存在しないとActions UIに表示されない。検証段階では`pull_request`トリガーのDraft PRで代替する。

**判断基準**: 検証用ブランチにのみワークフローがある状態では手動実行できないため

### 13. GEMINI.mdワークフロー定義の粒度

**要点**: GEMINI.mdには概要・アクション・必須引数のみ記載し、任意引数や詳細ロジックはプロンプトファイルに一元化する。

**判断基準**: 両方に書くと不整合が発生しやすく、モデルのプロンプト追従能力で十分カバーできる

### 14. 手動デプロイ手順の効率化

**要点**: パターン1（コードのみ）ではコンテナに入らず、`make prod-cache`・`make vite-build`で完結させる。

**判断基準**: コンテナへの出入りを繰り返す手順は非効率でミスの原因になる

---

## やってはいけないこと

1. SSHパスワード認証を有効化
2. rootで直接ログイン許可
3. MySQLのDocker化
4. mainでローカル用設定をコミット
5. SecretsにJSONやYAMLを保存
6. Dependabot PRをclose
7. `UploadedFile::fake()->create()`でマジックバイト検証が必要なテストを書く
8. 検証用PRやDraft PRで`Fixes #<issue>`を使う

---

## 技術選択と教訓

### 重要な技術選択の判断

1. **Service層のみ採用**: Repository層は個人開発では過剰
2. **実画像フィクスチャ採用**: Laravelの`fake()->image()`はWebP非対応のため
3. **Apidogのデータ駆動テスト**: ファイルアップロードでは実用的でない（手動切替で対応）

### 重要な教訓

1. Laravelの`UploadedFile::fake()->create()`はランダムバイト列を生成するため、マジックバイト検証では使用不可
2. テスト種別ごとに専用ドキュメントを作成し、タスクページには参照リンクのみ記載する
3. 汎用コンポーネントは全ユースケースを事前に想定しきれない。問題発生時に既存影響を避けて拡張する
4. 用語は早期に統一する（「アバター」vs「プロフィール画像」で後から全体修正が必要になった）
5. GitHub ActionsのワークフローはデフォルトブランチにないとUI上で認識されない。検証段階ではDraft PRで代替する
6. AIが自動生成したPR本文のラベルや用語は方針とズレることがある。判断基準をプロンプトに明示的に組み込む必要がある
7. CI検証→PR→マージ→デプロイを一度通しで実行すると、各ステップの役割と依存関係が体感として身につく

---

## 次のアクション

### Phase 1: ディレクトリ名変更（優先度: 高）

**工数**: 0.5日

**作業内容**: `manual/` → `manuals/` への変更、関連ドキュメント8件の相対パス更新

### Phase 2: CI/CD基盤の拡張（優先度: 高）

**工数**: 1-2日

**作業内容**:

- ワークフローをdevelop/mainに導入
- PR作成時の自動テスト（全テスト対象への拡張）
- ブランチ保護ルールの設定

### Phase 3: Service層リファクタリング（優先度: 中）

**工数**: 1-2日

**作業内容**: コーディング規約違反の修正と保守性向上（Issue #9）

### Phase 4: CD（自動デプロイ）（優先度: 中）

**工数**: 1日

**作業内容**: VPSへの自動デプロイ設定

---

## 特記事項

### プロジェクトの健全性評価

- **進捗**: 良好（プロフィール画像アップロード機能完了・本番稼働中、CI基盤導入済み）
- **技術的負債**: 低（Service層導入により責務分離が明確）
- **ドキュメント**: 良好（テスト種別ごとに専用ドキュメントを分離、PR運用ルール・デプロイ手順書策定済み）
- **開発プロセス**: Issue→ブランチ→PR→CI→マージ→デプロイの一連のフローを実証済み

### 次フェーズまでのクリティカルパス

- ディレクトリ名変更: 0.5日
- CI/CD基盤拡張: 1-2日
- CD設定: 1日
- **合計: 約2.5-3.5日**
